generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["submit"]
}

// ユーザー
model User {
  id            String    @id // Supabase Auth UID
  email         String    @unique
  name          String?
  image         String?
  lineUserId    String?   @unique // LINE連携用
  pledgedAt     DateTime? // 誓約完了日時（nullなら未誓約）

  // 通知設定
  notifyMorning Boolean   @default(true)  // 朝リマインド (9:00)
  notifyEvening Boolean   @default(true)  // 夜リマインド (21:00)
  notifyUrgent  Boolean   @default(true)  // 期限超過通知 (0:30)

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  pledge        Pledge?
  projects      Project[]
  submissions   Submission[]
  judgmentLogs  JudgmentLog[]
  penaltyLogs   PenaltyLog[]

  @@schema("submit")
}

// 誓約（オンボーディング時に作成、変更不可）
model Pledge {
  id              String   @id @default(cuid())
  userId          String   @unique
  agreedToTerms   Boolean  @default(true)  // 利用規約同意
  agreedToPenalty Boolean  @default(true)  // ペナルティ同意
  agreedToLine    Boolean  @default(true)  // LINE通知同意
  pledgeText      String   @db.Text        // ユーザーが入力した誓約文
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@schema("submit")
}

// プロジェクト（提出の単位）
model Project {
  id             String   @id @default(cuid())
  userId         String
  name           String
  description    String?  @db.Text

  // 提出頻度設定
  frequency      String   @default("weekly") // weekly, biweekly, monthly, custom
  judgmentDay    Int      @default(0)        // 0=日曜, 1=月曜, ..., 6=土曜
  customDays     Int?                        // カスタム頻度の場合の日数

  // ペナルティ設定
  penaltyAmount  Int      @default(1000)     // 罰金額（円）

  // 状態
  status         String   @default("active") // active, paused, archived

  // 次回判定日
  nextJudgmentDate DateTime?

  // 統計
  submissionCount     Int @default(0)
  missedCount         Int @default(0)
  totalPenaltyAmount  Int @default(0)

  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  submissions  Submission[]
  judgmentLogs JudgmentLog[]

  @@index([userId])
  @@index([status])
  @@index([nextJudgmentDate])
  @@schema("submit")
}

// 提出
model Submission {
  id           String   @id @default(cuid())
  userId       String
  projectId    String
  sequenceNum  Int               // 連番（#001, #002...）
  content      String   @db.Text // 提出内容（テキスト必須）
  lineMessageId String?  @unique // 冪等性: LINE メッセージID重複防止
  createdAt    DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([projectId])
  @@index([createdAt])
  @@schema("submit")
}

// 判定ログ
model JudgmentLog {
  id           String   @id @default(cuid())
  userId       String
  projectId    String
  judgmentDate DateTime
  submitted    Boolean           // 提出済みかどうか
  penaltyExecuted Boolean @default(false) // ペナルティ実行済みか
  penaltyAmount   Int?           // 実行されたペナルティ額
  createdAt    DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@unique([projectId, judgmentDate]) // 冪等性: 同一プロジェクト・判定日の重複防止
  @@index([userId])
  @@index([projectId])
  @@index([judgmentDate])
  @@schema("submit")
}

// ペナルティ実行ログ（Stripe決済記録）
model PenaltyLog {
  id              String   @id @default(cuid())
  userId          String
  amount          Int               // 金額
  stripePaymentId String?           // Stripe Payment Intent ID
  status          String   @default("pending") // pending, completed, failed
  reason          String?  @db.Text // 理由（どのプロジェクトの未提出か）
  createdAt       DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([status])
  @@schema("submit")
}
