generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["submit"]
}

model User {
  id            String    @id // Supabase Auth UID
  email         String    @unique
  name          String?
  image         String?
  role          String    @default("user") // user, supporter
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  memos              Memo[]
  aiCandidates       AiCandidate[]
  projects           Project[]
  projectSuggestions ProjectSuggestion[]

  // パートナー関係（自分がメインユーザー）
  supportersAsUser    Supporter[] @relation("UserSupporters")
  // パートナー関係（自分がサポーター）
  supportersAsPartner Supporter[] @relation("PartnerSupporters")

  // 受け取った応援
  cheersReceived      Cheer[]     @relation("CheersReceived")
  // 送った応援
  cheersSent          Cheer[]     @relation("CheersSent")

  // 通知
  notifications       Notification[]

  @@schema("submit")
}

// 観測ログ（メモ）
model Memo {
  id        String   @id @default(cuid())
  userId    String
  content   String   @db.Text
  type      String   @default("text") // text, voice, webclip
  tags      String?  // カンマ区切りのタグ
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user         User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiCandidates AiCandidate[] @relation("MemoToCandidates")

  @@index([userId])
  @@schema("submit")
}

// AIが生成したコンテンツ案
model AiCandidate {
  id        String   @id @default(cuid())
  userId    String
  content   String   @db.Text
  format    String   @default("tweet") // tweet, blog, note
  persona   String?  // 人格・口調テンプレート
  status    String   @default("pending") // pending, adopted, rejected
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  memos    Memo[]    @relation("MemoToCandidates")
  articles Article[]

  @@index([userId])
  @@index([status])
  @@schema("submit")
}

// AIコーチによるプロジェクト提案
model ProjectSuggestion {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String   @db.Text
  reasoning   String   @db.Text  // なぜこのプロジェクトを提案したか
  memoIds     String   @db.Text  // 関連するメモIDのJSON配列
  status      String   @default("pending") // pending, accepted, rejected
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user    User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  project Project? // 承認されたら作成されるプロジェクト

  @@index([userId])
  @@index([status])
  @@schema("submit")
}

// プロジェクト
model Project {
  id           String   @id @default(cuid())
  userId       String
  suggestionId String?  @unique // AIコーチの提案から作成された場合
  title        String
  description  String?  @db.Text
  rule         String?  @db.Text // JSON: 公開ルール設定
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user       User               @relation(fields: [userId], references: [id], onDelete: Cascade)
  suggestion ProjectSuggestion? @relation(fields: [suggestionId], references: [id])
  articles   Article[]

  @@index([userId])
  @@schema("submit")
}

// プロジェクトに格納された記事
model Article {
  id          String    @id @default(cuid())
  projectId   String
  candidateId String?
  content     String    @db.Text
  publishedAt DateTime?
  platform    String?   // x, note, blog
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  project   Project      @relation(fields: [projectId], references: [id], onDelete: Cascade)
  candidate AiCandidate? @relation(fields: [candidateId], references: [id])

  @@index([projectId])
  @@schema("submit")
}

// パートナーシップ情報
model Supporter {
  id              String   @id @default(cuid())
  userId          String   // メインユーザー
  supporterUserId String   // サポーター
  status          String   @default("pending") // pending, active, rejected
  inviteToken     String?  @unique
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  user      User @relation("UserSupporters", fields: [userId], references: [id], onDelete: Cascade)
  supporter User @relation("PartnerSupporters", fields: [supporterUserId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([supporterUserId])
  @@schema("submit")
}

// 通知ログ
model Notification {
  id        String   @id @default(cuid())
  userId    String   // 通知を受け取る人（サポーター）
  type      String   // new_content, milestone, system, project_suggestion
  content   String   @db.Text
  read      Boolean  @default(false)
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([read])
  @@schema("submit")
}

// 応援ログ
model Cheer {
  id              String   @id @default(cuid())
  userId          String   // 応援を受け取る人
  supporterUserId String   // 応援を送る人
  message         String
  createdAt       DateTime @default(now())

  user      User @relation("CheersReceived", fields: [userId], references: [id], onDelete: Cascade)
  supporter User @relation("CheersSent", fields: [supporterUserId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@schema("submit")
}
